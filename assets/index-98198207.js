(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const c of o)if(c.type==="childList")for(const r of c.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function n(o){const c={};return o.integrity&&(c.integrity=o.integrity),o.referrerPolicy&&(c.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?c.credentials="include":o.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function s(o){if(o.ep)return;o.ep=!0;const c=n(o);fetch(o.href,c)}})();function R(e,t){fetch("https://31.javascript.htmlacademy.pro/kekstagram/data").then(n=>n.json()).then(n=>{e(n)}).catch(()=>{t()})}function $(e,t,n){fetch("https://31.javascript.htmlacademy.pro/kekstagram",{method:"POST",body:e}).then(s=>{if(!s.ok)throw new Error(`Ошибка: ${s.status}`);t()}).catch(()=>{n()})}const z=500,v=e=>e.key==="Escape";function B(e){return new Set(e).size!==e.length}function G(e,t=z){let n;return(...s)=>{clearTimeout(n),n=setTimeout(()=>e.apply(this,s),t)}}const H=5,q=document.querySelector(".social__comments"),f=document.querySelector(".social__comments-loader"),j=document.querySelector(".social__comment-total-count"),K=document.querySelector(".social__comment-shown-count"),V={listener:null,renderComments(e){let t=0;q.textContent="",f.classList.remove("hidden"),this.listener&&f.removeEventListener("click",this.listener);function n(){j.textContent=e.length;const s=document.createDocumentFragment(),o=e.slice(t,t+H);o.forEach(c=>{const r=document.createElement("li");r.classList.add("social__comment");const i=document.createElement("img");i.classList.add("social__picture"),i.src=c.avatar,i.alt=c.name,r.append(i);const d=document.createElement("p");d.classList.add("social__text"),d.textContent=c.message,r.append(d),s.append(r)}),t+=o.length,K.textContent=t,t>=e.length&&f.classList.add("hidden"),q.append(s)}n(),e.length>5&&(this.listener=()=>n(),f.addEventListener("click",this.listener))}},a=document.querySelector(".big-picture"),X=e=>{const t=a.querySelector(".big-picture__img").querySelector("img"),n=a.querySelector(".likes-count"),s=a.querySelector(".social__comment-shown-count"),o=a.querySelector(".social__caption");t.src=e.url,n.textContent=e.likes,s.textContent=e.comments.length,o.textContent=e.description,V.renderComments(e.comments)},M=function(e){v(e)&&(e.preventDefault(),a.classList.add("hidden"),document.body.classList.remove("modal-open"))},W=function(){a.querySelector(".big-picture__cancel").addEventListener("click",()=>{a.classList.add("hidden"),document.body.classList.remove("modal-open")}),document.removeEventListener("keydown",M)};W();const k=document.querySelector(".pictures"),Y=document.querySelector("#picture").content.querySelector(".picture"),b=document.createDocumentFragment(),w=e=>{document.querySelector(".img-filters").classList.remove("img-filters--inactive"),e.forEach(({id:t,url:n,description:s,likes:o,comments:c})=>{const r=Y.cloneNode(!0);r.querySelector(".picture__img").src=n,r.querySelector(".picture__img").alt=s,r.querySelector(".picture__likes").textContent=o,r.querySelector(".picture__comments").textContent=c.length,r.dataset.pictureId=t,b.appendChild(r)}),k.append(b),k.addEventListener("click",t=>{const n=t.target.closest(".picture");if(n){t.preventDefault();const s=e.find(o=>o.id===Number(n.dataset.pictureId));X(s),document.addEventListener("keydown",M),a.classList.remove("hidden"),document.body.classList.add("modal-open")}})},Q=["gif","jpg","jpeg","png"],T=document.querySelector("#upload-file"),J=document.querySelector(".img-upload__preview img");function Z(){T.addEventListener("change",()=>{const e=T.files[0],t=e.name.toLowerCase();Q.some(s=>t.endsWith(s))&&(J.src=URL.createObjectURL(e))})}const ee=document.querySelector(".scale__control--bigger"),te=document.querySelector(".scale__control--smaller"),ne=document.querySelector(".scale__control--value"),l=document.querySelector(".img-upload__preview img"),oe=document.querySelector(".img-upload__effects"),y=document.querySelector(".img-upload__effect-level"),re=document.querySelector(".effect-level__value"),_=document.querySelector(".effect-level__slider"),I=document.querySelector("#effect-none"),u={START:100,STEP:25,MIN:25,MAX:100};function ce(){let e=u.START;function t(){ne.value=`${e}%`,l.style.transform=`scale(${e/100})`}return{minimizeImage(){e>u.MIN&&(e-=u.STEP,t())},enlargeImage(){e<u.MAX&&(e+=u.STEP,t())},resetEditor(){e=u.START,t(),l.style.filter=""}}}const S=ce(),m={none:{key:"none",range:{min:0,max:100},step:1,start:100,prefix:""},chrome:{key:"grayscale",range:{min:0,max:1},step:.1,start:1,prefix:""},sepia:{key:"sepia",range:{min:0,max:1},step:.1,start:1,prefix:""},marvin:{key:"invert",range:{min:0,max:100},step:1,start:100,prefix:"%"},phobos:{key:"blur",range:{min:0,max:3},step:.1,start:3,prefix:"px"},heat:{key:"brightness",range:{min:1,max:3},step:.1,start:3,prefix:""}};te.addEventListener("click",S.minimizeImage);ee.addEventListener("click",S.enlargeImage);noUiSlider.create(_,{start:m.none.start,connect:"lower",range:m.none.range,step:m.none.step});I.checked&&(y.classList.add("hidden"),l.style.filter="");const se=()=>{I.checked=!0,y.classList.add("hidden"),l.style.filter=""},ie=e=>{const t=m[e];t.key==="none"?y.classList.add("hidden"):y.classList.remove("hidden"),_.noUiSlider.updateOptions({range:t.range,start:t.start,step:t.step}),t.key!=="none"?l.style.filter=`${t.key}(${t.start}${t.prefix})`:l.style.filter=""};_.noUiSlider.on("update",()=>{const e=_.noUiSlider.get();re.value=parseFloat(e);const t=document.querySelector('.img-upload__effects input[type="radio"]:checked'),n=m[t.value];n!=="none"?l.style.filter=`${n.key}(${e}${n.prefix})`:l.style.filter=""});oe.addEventListener("change",e=>{e.target.matches('input[type="radio"]')&&ie(e.target.value)});Z();const F=140,ae=5,le=/^(#[a-zа-яё0-9]{1,19})(\s+#[a-zа-яё0-9]{1,19})*$/i,D=document.querySelector(".img-upload__form"),de=document.querySelector(".img-upload__input"),A=document.querySelector(".img-upload__overlay"),N=document.querySelector("body"),p=document.querySelector(".text__hashtags"),E=document.querySelector(".text__description"),P=document.querySelector(".img-upload__cancel"),ue=`Длина комментария больше ${F} символов`,U=e=>{v(e)&&!p.matches(":focus")&&!E.matches(":focus")&&(e.preventDefault(),L())},O=()=>{L()},me=()=>{A.classList.remove("hidden"),N.classList.add("modal-open"),p.value="",E.value="",document.addEventListener("keydown",U),P.addEventListener("click",O)},pe=e=>e.length<=F;function L(){A.classList.add("hidden"),N.classList.remove("modal-open"),D.reset(),S.resetEditor(),se(),document.removeEventListener("keydown",U),P.removeEventListener("click",O)}const g=new Pristine(D,{classTo:"img-upload__field-wrapper",errorClass:"img-upload__field-wrapper--error",errorTextParent:"img-upload__field-wrapper",errorTextTag:"p"}),ge=()=>g.validate();g.addValidator(p,fe,"Введён невалидный хэштег");function fe(e){const t=e.trim().toLowerCase();return t===""?!0:le.test(t)}g.addValidator(p,ye,"Хэштеги повторяются");function ye(e){const t=e.trim().toLowerCase().split(/\s+/);return!B(t)}g.addValidator(p,_e,"Превышено количество хэштегов");function _e(e){return!(e.trim().toLowerCase().split(/\s+/).length>ae)}g.addValidator(E,pe,ue);de.addEventListener("change",me);const h=document.querySelector(".img-upload__submit"),he=document.querySelector(".img-upload__form"),ve=()=>{h.disabled=!0,h.textContent="Публикую..."},x=()=>{h.disabled=!1,h.textContent="Опубликовать"};function Se(){const t=document.querySelector("#data-error").content.cloneNode(!0),n=document.createElement("div");n.appendChild(t),document.body.appendChild(n),setTimeout(()=>{n.remove()},5e3)}function Ee(){const e=document.querySelector("#success").content.cloneNode(!0),t=document.createElement("div");t.appendChild(e),document.body.appendChild(t);const n=t.querySelector(".success__button"),s=t.querySelector(".success__inner"),o=function(r){v(r)&&(r.preventDefault(),t.remove())},c=function(r){s.contains(r.target)||t.remove()};n.addEventListener("click",()=>{t.remove()}),document.addEventListener("keydown",o),document.addEventListener("click",c)}function Le(){const e=document.querySelector("#error").content.cloneNode(!0),t=document.createElement("div");t.appendChild(e),document.body.appendChild(t);const n=t.querySelector(".error__button"),s=t.querySelector(".error__inner");function o(r){v(r)&&(r.preventDefault(),r.stopPropagation(),t.remove(),document.body.removeEventListener("keydown",o),document.removeEventListener("click",c))}function c(r){s.contains(r.target)||(t.remove(),document.body.removeEventListener("keydown",o),document.removeEventListener("click",c))}n.addEventListener("click",()=>{t.remove()}),document.body.addEventListener("keydown",o),document.addEventListener("click",c)}he.addEventListener("submit",e=>{if(e.preventDefault(),!ge())return;ve();const t=new FormData(e.target);$(t,()=>{Ee(),x(),L()},()=>{Le(),x()})});const Ce=document.querySelector(".img-filters"),qe={"filter-default":e=>e,"filter-random":e=>e.toSorted(()=>.5-Math.random()).slice(0,10),"filter-discussed":e=>e.toSorted((t,n)=>n.comments.length-t.comments.length)};function ke(e,t){const n=e,s=G(c=>{document.querySelectorAll(".picture").forEach(r=>r.remove()),t(c)});function o(c){const r=document.querySelector(".img-filters__button--active"),i=c.target;let d=[];if(!c.target.matches(".img-filters__button"))return;if(i.classList.add("img-filters__button--active"),r.classList.remove("img-filters__button--active"),r.id===i.id){i.classList.add("img-filters__button--active");return}const C=qe[c.target.id];C&&(d=C(n),s(d))}Ce.addEventListener("click",o)}R(e=>{w(e),ke(e,w)},Se);
